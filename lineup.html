<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© â€“ OUR CAMEL</title>

<style>
:root{
  --bg:#1c2245;
  --pitch:#e4bd79;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  background:var(--bg);
  display:flex;
  justify-content:center;
  padding:10px;
  font-family:'Tahoma',sans-serif;
}

.canvas{
  width:390px;
  height:844px;
  background:var(--bg);
  position:relative;
  border-radius:16px;
  overflow:hidden;
  direction:rtl;
}

/* Ø§Ù„Ù„ÙˆØ¬Ùˆ */
.logo{
  position:absolute;
  top:60px;
  width:100%;
  text-align:center;
  z-index:5;
}
.logo img{ height:46px; }

/* Ø²Ø± Ø§Ù„Ø­ÙØ¸ */
#saveImageBtn{
  position:absolute;
  top:20px;
  right:20px;
  padding:8px 16px;
  background:var(--pitch);
  color:var(--bg);
  font-weight:bold;
  border:none;
  font-size:12px;
  border-radius:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.4);
  cursor:pointer;
  z-index:50;
}

/* Ø§Ù„Ù…Ù„Ø¹Ø¨ */
.pitch-wrapper{
  position:absolute;
  top:120px;
  left:20px;
  right:20px;
  height:540px;
  border-radius:14px;
  overflow:hidden;
}
.pitch-wrapper svg{
  width:100%;
  height:100%;
  display:block;
}

/* Ø·Ø¨Ù‚Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙˆÙ‚ Ø§Ù„Ù…Ù„Ø¹Ø¨ */
.players-layer{
  position:absolute;
  inset:0;
  z-index:20;
  pointer-events:none;
}

/* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø¯Ø§Ø¦Ø±Ø© + Ø§Ø³Ù…) */
.player-spot{
  position:absolute;
  width:66px;
  height:66px;
  transform:translate(-50%,-50%);
  border-radius:50%;
  background:var(--pitch);
  border:4px solid #00000055;
  box-shadow:0 5px 14px rgba(0,0,0,0.35);
  display:flex;
  align-items:center;
  justify-content:center;
}

.player-spot img{
  width:58px;
  height:58px;
  border-radius:50%;
  object-fit:cover;
  display:block;
}

.player-name{
  position:absolute;
  top:70px;
  left:50%;
  transform:translateX(-50%);
  width:max-content;
  max-width:150px;
  font-size:12px;
  font-weight:800;
  color:var(--pitch);
  text-shadow:0 3px 10px rgba(0,0,0,0.5);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Ø®ØªÙ… X (ØµÙˆØ±Ø© + @username) */
.stamp{
  position:absolute;
  left:18px;
  bottom:18px;
  display:none;           /* ÙŠØ¸Ù‡Ø± Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ userX */
  align-items:center;
  gap:10px;
  z-index:30;
}
.stamp .avatar{
  width:74px;
  height:74px;
  border-radius:50%;
  border:7px solid var(--pitch);
  background:#00000022;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}
.stamp .avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.stamp .handle{
  color:var(--pitch);
  font-size:16px;
  font-weight:900;
  direction:ltr;
  text-shadow:0 3px 10px rgba(0,0,0,0.45);
}
</style>
</head>

<body>

<div id="captureArea" class="canvas">

  <button id="saveImageBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button>

  <div class="logo">
    <img id="logoImg" alt="OUR CAMEL" crossorigin="anonymous">
  </div>

  <!-- Ø§Ù„Ù…Ù„Ø¹Ø¨ -->
  <div class="pitch-wrapper" id="pitchWrap">

    <svg viewBox="0 0 360 600" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="pitchGrad" gradientUnits="userSpaceOnUse" x1="20" y1="60" x2="20" y2="540">
          <stop offset="0%" stop-color="#1c2245" />
          <stop offset="50%" stop-color="#262c55" />
          <stop offset="100%" stop-color="#1c2245" />
        </linearGradient>
      </defs>

      <!-- Ø£Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ù„Ø¹Ø¨ -->
      <rect x="20" y="60" width="320" height="480" fill="url(#pitchGrad)" />

      <!-- Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ù„Ø¹Ø¨ -->
      <rect x="20" y="60" width="320" height="480" fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <line x1="20" y1="300" x2="340" y2="300" stroke="var(--pitch)" stroke-width="3"/>
      <circle cx="180" cy="300" r="48" fill="none" stroke="var(--pitch)" stroke-width="3"/>

      <rect x="90" y="60" width="180" height="110" fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <rect x="130" y="60" width="100" height="60" fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <path d="M 150 170 A 30 30 0 0 0 210 170" fill="none" stroke="var(--pitch)" stroke-width="3"/>

      <rect x="90" y="430" width="180" height="110" fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <rect x="130" y="480" width="100" height="60" fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <path d="M 150 430 A 30 30 0 0 1 210 430" fill="none" stroke="var(--pitch)" stroke-width="3"/>
    </svg>

    <!-- Ø·Ø¨Ù‚Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
    <div class="players-layer" id="playersLayer"></div>

    <!-- Ø®ØªÙ… X -->
    <div class="stamp" id="stamp">
      <div class="avatar"><img id="stampAvatar" alt="X Avatar" crossorigin="anonymous"></div>
      <div class="handle" id="stampHandle">@USER</div>
    </div>

  </div>
</div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
// ---------- CORS Proxy (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹) ----------
function corsProxy(url){
  if(!url) return "";
  try{
    const clean = url.replace(/^https?:\/\//,'');
    return `https://images.weserv.nl/?url=${encodeURIComponent(clean)}&output=png`;
  }catch(e){
    return url;
  }
}

function preloadImage(url){
  return new Promise(resolve=>{
    if(!url) return resolve();
    const im = new Image();
    im.crossOrigin = "anonymous";
    im.onload = ()=>resolve();
    im.onerror = ()=>resolve();
    im.src = url;
  });
}

async function waitAllImages(container){
  const imgs = Array.from(container.querySelectorAll("img"));
  await Promise.all(imgs.map(img=>{
    if(img.complete && img.naturalWidth > 0) return Promise.resolve();
    return new Promise(res=>{
      img.onload = ()=>res();
      img.onerror = ()=>res();
    });
  }));
}

// ---------- Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø§Øª (Ù†ÙØ³ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ) ----------
const formations = {
  "4-4-2":[
    {x:50,  y:88},
    {x:25,  y:70},
    {x:40,  y:68},
    {x:60,  y:68},
    {x:75,  y:70},
    {x:22,  y:52},
    {x:40,  y:48},
    {x:60,  y:48},
    {x:78,  y:52},
    {x:42,  y:30},
    {x:58,  y:30}
  ],
  "4-3-3":[
    {x:50, y:14},
    {x:20, y:30},
    {x:40, y:30},
    {x:60, y:30},
    {x:80, y:30},
    {x:30, y:50},
    {x:50, y:48},
    {x:70, y:50},
    {x:22, y:70},
    {x:50, y:68},
    {x:78, y:70}
  ],
  "4-2-3-1":[
    {x:50, y:14},
    {x:20, y:30},
    {x:40, y:30},
    {x:60, y:30},
    {x:80, y:30},
    {x:42, y:44},
    {x:58, y:44},
    {x:30, y:58},
    {x:50, y:56},
    {x:70, y:58},
    {x:50, y:72}
  ]
};

const pitchWrap = document.getElementById("pitchWrap");
const playersLayer = document.getElementById("playersLayer");

// ---------- Ø¨Ù†Ø§Ø¡ 11 Ù„Ø§Ø¹Ø¨ ÙƒÙ€ HTML ----------
function buildPlayerSpots(){
  playersLayer.innerHTML = "";
  const arr = [];
  for(let i=0;i<11;i++){
    const spot = document.createElement("div");
    spot.className = "player-spot";
    spot.dataset.index = String(i);

    const img = document.createElement("img");
    img.alt = "player";
    img.crossOrigin = "anonymous";

    const name = document.createElement("div");
    name.className = "player-name";

    spot.appendChild(img);
    spot.appendChild(name);

    playersLayer.appendChild(spot);
    arr.push(spot);
  }
  return arr;
}

let spots = buildPlayerSpots();

// ØªØ­ÙˆÙŠÙ„ Ù†Ø³Ø¨Ø© Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
function pctToXY(px, py){
  const rect = pitchWrap.getBoundingClientRect();
  return {
    x: (px/100) * rect.width,
    y: (py/100) * rect.height
  };
}

function applyLineup(data){
  const formationKey = data?.formation || "4-4-2";
  const f = formations[formationKey] || formations["4-4-2"];

  for(let i=0;i<11;i++){
    const spot = spots[i];
    const pos = f[i] || {x:50,y:50};
    const {x,y} = pctToXY(pos.x, pos.y);

    spot.style.left = x + "px";
    spot.style.top  = y + "px";

    const imgEl = spot.querySelector("img");
    const nameEl = spot.querySelector(".player-name");

    const pl = (data?.spots && data.spots[i]) ? data.spots[i] : null;

    nameEl.textContent = pl?.name || "";
    imgEl.src = pl?.img ? corsProxy(pl.img) : "";
  }
}

// ---------- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage ----------
let currentData = null;

(function init(){
  // Ø§Ù„Ù„ÙˆØ¬Ùˆ
  document.getElementById("logoImg").src = corsProxy("https://i.postimg.cc/pdy9nJdV/IMG-1720.png");

  const s = localStorage.getItem("currentLineup");
  if(s){
    try{ currentData = JSON.parse(s); }catch(e){ currentData = null; }
  }
  if(!currentData){
    // fallback Ø®ÙÙŠÙ
    currentData = { formation:"4-4-2", spots: Array.from({length:11}, ()=>({name:"",img:""})) };
  }

  applyLineup(currentData);

  // Ø®ØªÙ… X
  const userXraw = (localStorage.getItem("userX") || "").trim();
  const userX = userXraw.replace(/^@/,'');
  const stamp = document.getElementById("stamp");
  const stampHandle = document.getElementById("stampHandle");
  const stampAvatar = document.getElementById("stampAvatar");

  if(userX){
    stampHandle.textContent = "@"+userX;
    stampAvatar.src = corsProxy(`https://unavatar.io/twitter/${userX}`);
    stamp.style.display = "flex";
  }else{
    stamp.style.display = "none";
  }
})();

window.addEventListener("resize", ()=>{
  applyLineup(currentData);
});

// ---------- Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ----------
document.getElementById("saveImageBtn").onclick = async ()=>{
  const capture = document.getElementById("captureArea");

  // ØªØ£ÙƒØ¯ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† + Ø§Ù„Ù„ÙˆØ¬Ùˆ + Ø§Ù„Ø®ØªÙ… (Ø¥Ù† ÙˆØ¬Ø¯)
  await waitAllImages(capture);

  try{
    const canvas = await html2canvas(capture, {
      useCORS: true,
      allowTaint: false,
      backgroundColor: null,
      scale: 2,
      logging: false
    });

    const a = document.createElement("a");
    a.download = "lineup.png";
    a.href = canvas.toDataURL("image/png");
    a.click();
  }catch(err){
    console.error(err);
    alert("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
  }
};
</script>

</body>
</html>
