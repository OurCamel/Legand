<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© â€“ OUR CAMEL</title>

<style>
:root{
  --bg:#1c2245;
  --pitch:#e4bd79;
}

body{
  margin:0;
  background:var(--bg);
  display:flex;
  justify-content:center;
  padding:10px;
  font-family:'Tahoma',sans-serif;
}

.canvas{
  width:390px;
  height:844px;
  background:var(--bg);
  position:relative;
  border-radius:16px;
  overflow:hidden;
  direction:rtl;
}

/* Ø§Ù„Ù„ÙˆØ¬Ùˆ */
.logo{
  position:absolute;
  top:60px;
  width:100%;
  text-align:center;
  z-index:5;
}
.logo img{
  height:46px;
}

/* Ø§Ù„Ù…Ù„Ø¹Ø¨ */
.pitch-wrapper{
  position:absolute;
  top:120px;
  left:20px;
  right:20px;
  height:540px;
  border-radius:14px;
  overflow:hidden;
}
.pitch-wrapper svg{
  width:100%;
  height:100%;
  display:block;
}

/* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ */
.spot-ring{
  fill:var(--pitch);
  stroke:#00000055;
  stroke-width:4;
  filter:url(#shadow);
}
.spot-name{
  fill:var(--pitch);
  font-size:11px;
  font-weight:bold;
  text-anchor:middle;
}

/* Ø²Ø± Ø§Ù„Ø­ÙØ¸ */
#saveImageBtn{
  position:absolute;
  top:20px;
  right:20px;
  padding:8px 16px;
  background:var(--pitch);
  color:var(--bg);
  font-weight:bold;
  border:none;
  font-size:12px;
  border-radius:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.4);
  cursor:pointer;
  z-index:20;
}

/* Ø®ØªÙ… X (ØµÙˆØ±Ø© + @username) */
.stamp{
  position:absolute;
  left:18px;
  bottom:18px;
  display:none;
  align-items:center;
  gap:10px;
  z-index:25;
}
.stamp .avatar{
  width:74px;
  height:74px;
  border-radius:50%;
  border:7px solid var(--pitch);
  background:#00000022;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}
.stamp .avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.stamp .handle{
  color:var(--pitch);
  font-size:16px;
  font-weight:900;
  direction:ltr;
  text-shadow:0 3px 10px rgba(0,0,0,0.45);
}
</style>
</head>

<body>

<div id="captureArea" class="canvas">

  <button id="saveImageBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button>

  <div class="logo">
    <img id="logoImg" src="https://i.postimg.cc/pdy9nJdV/IMG-1720.png" alt="OUR CAMEL" crossorigin="anonymous">
  </div>

  <!-- Ø®ØªÙ… X -->
  <div class="stamp" id="stamp">
    <div class="avatar">
      <img id="stampAvatar" alt="X Avatar" crossorigin="anonymous">
    </div>
    <div class="handle" id="stampHandle">@USER</div>
  </div>

  <!-- Ø§Ù„Ù…Ù„Ø¹Ø¨ -->
  <div class="pitch-wrapper">
    <svg id="pitchSvg" viewBox="0 0 360 600" xmlns="http://www.w3.org/2000/svg">

      <defs>
        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="3" stdDeviation="3" flood-color="rgba(0,0,0,0.45)"/>
        </filter>

        <linearGradient id="pitchGrad" gradientUnits="userSpaceOnUse"
                        x1="20" y1="60" x2="20" y2="540">
          <stop offset="0%" stop-color="#1c2245" />
          <stop offset="50%" stop-color="#262c55" />
          <stop offset="100%" stop-color="#1c2245" />
        </linearGradient>
      </defs>

      <!-- Ø£Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ù„Ø¹Ø¨ -->
      <rect x="20" y="60" width="320" height="480" fill="url(#pitchGrad)" />

      <!-- Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ù„Ø¹Ø¨ -->
      <rect x="20" y="60" width="320" height="480"
            fill="none" stroke="var(--pitch)" stroke-width="3"/>

      <line x1="20" y1="300" x2="340" y2="300"
            stroke="var(--pitch)" stroke-width="3"/>

      <circle cx="180" cy="300" r="48"
              fill="none" stroke="var(--pitch)" stroke-width="3"/>

      <rect x="90" y="60" width="180" height="110"
            fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <rect x="130" y="60" width="100" height="60"
            fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <path d="M 150 170 A 30 30 0 0 0 210 170"
            fill="none" stroke="var(--pitch)" stroke-width="3"/>

      <rect x="90" y="430" width="180" height="110"
            fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <rect x="130" y="480" width="100" height="60"
            fill="none" stroke="var(--pitch)" stroke-width="3"/>
      <path d="M 150 430 A 30 30 0 0 1 210 430"
            fill="none" stroke="var(--pitch)" stroke-width="3"/>

      <!-- 11 Ù…ÙˆØ¶Ø¹ Ù„Ø§Ø¹Ø¨ -->
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>
      <g class="spot"><circle class="spot-ring" r="30"/><image class="spot-img" width="60" height="60"/><text class="spot-name"></text></g>

    </svg>
  </div>

</div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
// --- CORS Proxy (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØ± Ù…Ø§ ØªØ®ØªÙÙŠ ÙˆÙ‚Øª Ø§Ù„Ø­ÙØ¸) ---
function corsProxy(url){
  if(!url) return "";
  try{
    const clean = url.replace(/^https?:\/\//,'');
    return `https://images.weserv.nl/?url=${encodeURIComponent(clean)}&output=png`;
  }catch(e){
    return url;
  }
}

// ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© (Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØ±)
function preloadImage(url){
  return new Promise(resolve=>{
    if(!url) return resolve();
    const im = new Image();
    im.crossOrigin = "anonymous";
    im.onload = ()=>resolve();
    im.onerror = ()=>resolve();
    im.src = url;
  });
}

// Ù†ÙØ³ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù„Ø¹Ø¨ Ù…Ø«Ù„ index
const PITCH_LEFT = 40;
const PITCH_RIGHT = 320;
const PITCH_TOP = 60;
const PITCH_BOTTOM = 540;
const W = PITCH_RIGHT - PITCH_LEFT;
const H = PITCH_BOTTOM - PITCH_TOP;

function mx(p){ return PITCH_LEFT + (p/100)*W; }
function my(p){ return PITCH_TOP + (p/100)*H; }

// Ù†ÙØ³ Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø§Øª
const formations = {
  "4-4-2":[
    {x:50,  y:88},  // GK
    {x:25,  y:70},  // LB
    {x:40,  y:68},  // LCB
    {x:60,  y:68},  // RCB
    {x:75,  y:70},  // RB
    {x:22,  y:52},  // LM
    {x:40,  y:48},  // LCM
    {x:60,  y:48},  // RCM
    {x:78,  y:52},  // RM
    {x:42,  y:30},  // LF
    {x:58,  y:30}   // RF
  ],
  "4-3-3":[
    {x:50, y:14},  // GK
    {x:20, y:30},  // LB
    {x:40, y:30},  // LCB
    {x:60, y:30},  // RCB
    {x:80, y:30},  // RB
    {x:30, y:50},  // LCM
    {x:50, y:48},  // CM
    {x:70, y:50},  // RCM
    {x:22, y:70},  // LW
    {x:50, y:68},  // ST
    {x:78, y:70}   // RW
  ],
  "4-2-3-1":[
    {x:50, y:14},  // GK
    {x:20, y:30},  // LB
    {x:40, y:30},  // LCB
    {x:60, y:30},  // RCB
    {x:80, y:30},  // RB
    {x:42, y:44},  // DM1
    {x:58, y:44},  // DM2
    {x:30, y:58},  // AM-L
    {x:50, y:56},  // AM-C
    {x:70, y:58},  // AM-R
    {x:50, y:72}   // ST
  ]
};

const spots = [...document.querySelectorAll(".spot")];

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®ØªÙ…
const stamp = document.getElementById("stamp");
const stampAvatar = document.getElementById("stampAvatar");
const stampHandle = document.getElementById("stampHandle");

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ´ÙƒÙŠÙ„Ø© Ù…Ù† localStorage
let currentData = null;

(function load(){
  const dataStr = localStorage.getItem("currentLineup");
  if(!dataStr) return;

  try{
    currentData = JSON.parse(dataStr);
  }catch(e){
    console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© currentLineup Ù…Ù† localStorage", e);
    return;
  }

  // Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ
  document.getElementById("logoImg").src = corsProxy("https://i.postimg.cc/pdy9nJdV/IMG-1720.png");

  const f = formations[currentData.formation] || formations["4-4-2"];

  currentData.spots.forEach((pl,i)=>{
    if(!f[i] || !spots[i]) return;

    const pos = f[i];
    const cx = mx(pos.x);
    const cy = my(pos.y);

    const s = spots[i];
    const ring = s.querySelector(".spot-ring");
    const img = s.querySelector(".spot-img");
    const name = s.querySelector(".spot-name");

    ring.setAttribute("cx",cx);
    ring.setAttribute("cy",cy);

    img.setAttribute("x",cx-30);
    img.setAttribute("y",cy-30);

    // Ù…Ù‡Ù…: ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ
    if(pl.img){
      const url = corsProxy(pl.img);
      img.setAttribute("href", url);
      // Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
      img.setAttributeNS("http://www.w3.org/1999/xlink", "href", url);
    }

    name.setAttribute("x",cx);
    name.setAttribute("y",cy+42);
    name.textContent = pl.name || "";
  });

  // Ø®ØªÙ… Ø­Ø³Ø§Ø¨ X (ØµÙˆØ±Ø© + Ø§Ø³Ù…)
  const userX = localStorage.getItem("userX") || "";
  if(userX){
    stampHandle.textContent = "@"+userX.replace(/^@/,'');
    stampAvatar.src = corsProxy(`https://unavatar.io/twitter/${userX.replace(/^@/,'')}`);
    stamp.style.display = "flex";
  }else{
    stamp.style.display = "none";
  }
})();

// Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© PNG
document.getElementById("saveImageBtn").onclick = async ()=>{
  const capture = document.getElementById("captureArea");

  // Ù†Ø¬Ù‡Ù‘Ø² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù„ÙŠ Ù„Ø§Ø²Ù… ØªØªØ­Ù…Ù‘Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØ±
  const imagesToLoad = [];

  // Ù„ÙˆØ¬Ùˆ
  imagesToLoad.push(preloadImage(document.getElementById("logoImg").src));

  // Ø®ØªÙ… X (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯)
  if(stamp.style.display !== "none"){
    imagesToLoad.push(preloadImage(stampAvatar.src));
  }

  // ØµÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ù…Ù† currentData)
  if(currentData && Array.isArray(currentData.spots)){
    currentData.spots.forEach(pl=>{
      if(pl && pl.img) imagesToLoad.push(preloadImage(corsProxy(pl.img)));
    });
  }

  await Promise.all(imagesToLoad);

  // ØªØµÙˆÙŠØ±
  html2canvas(capture, {
    useCORS: true,
    allowTaint: false,
    backgroundColor: null,
    scale: 2,
    logging: false,
    foreignObjectRendering: true
  }).then(c=>{
    const a = document.createElement("a");
    a.download = "lineup.png";
    a.href = c.toDataURL("image/png");
    a.click();
  }).catch(err=>{
    console.error(err);
    alert("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
  });
};
</script>

</body>
</html>
